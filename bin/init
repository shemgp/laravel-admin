#!/usr/bin/php
<?php

$file = 'composer.json';

if (!file_exists($file))
{
    echo "ERROR: Can't find composer.json in current directory.\n";
    die();
}

echo "Updating composer.json.. ";
$composer_json = json_decode(file_get_contents($file), true);

$composer_json['require']['encore/laravel-admin'] = "dev-changes";

$composer_json['repositories']['laravel-admin'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/laravel-admin.git"
    ];

$composer_json['require']['infyomlabs/laravel-generator'] = "dev-5.5-datagrid-bootform-patches";
$composer_json['require']['infyomlabs/adminlte-templates'] = "dev-5.5-datagrid-bootform-patches";

$composer_json['repositories']['laravel-generator'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/laravel-generator.git"
    ];
$composer_json['repositories']['adminlte-templates'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/adminlte-templates.git"
    ];
$composer_json['repositories']['datagrid'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/datagrid"
    ];
$composer_json['repositories']['bootstrap-form'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/bootstrap-form.git"
    ];

$composer_json["minimum-stability"] = "dev";

file_put_contents($file, json_encode($composer_json, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
echo "done\n";

echo "Running composer update.. \n";
shell_exec("composer update");
echo "done\n";

echo "Running configs.. ";

$autoload_file = 'vendor/autoload.php';
$bootstrap_file = 'bootstrap/app.php';
if (!file_exists($autoload_file) && !file_exists($bootstrap_file))
{
    echo "ERROR: Can't find $autoload_file & $boostrap_file for running artisan commands.\n";
    die();
}
require_once 'vendor/autoload.php';
$app = require_once 'bootstrap/app.php';
class_alias('Illuminate\Support\Facades\Facade', 'Facade');
Facade::setFacadeApplication($app);
class_alias('Illuminate\Support\Facades\Artisan', 'Artisan');
Artisan::call('vendor:publish', ['--all' => 1]);
Artisan::call('admin:install', ['-n' => 1]);
Artisan::call("infyom:publish", ['-n' => 1]);
Artisan::call("infyom.publish:layout", ['-n' => 1]);

echo "done\n";

echo "Changing Infyom Generator's default layout.. ";
$config_file = 'config/infyom/laravel_generator.php';
$config = file_get_contents($config_file);
$config = preg_replace('/\'default_layout\'.*=> \$package_view_name.\'[^\']*\',/',
    '\'default_layout\'    => $package_view_name.\'admin::index\',', $config);
file_put_contents($config_file, $config);
echo "done\n";
