#!/usr/bin/php
<?php

$file = 'composer.json';

if (!file_exists($file))
{
    echo "Can't find composer.json in current directory.\n";
    die();
}

echo "Updating composer.json...";
$composer_json = json_decode(file_get_contents($file), true);

$composer_json['require']['encore/laravel-admin'] = "dev-changes";

$composer_json['repositories']['laravel-admin'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/laravel-admin.git"
    ];

$composer_json['require']['infyomlabs/laravel-generator'] = "dev-5.5-datagrid-bootform-patches";
$composer_json['require']['infyomlabs/adminlte-templates'] = "dev-5.5-datagrid-bootform-patches";

$composer_json['repositories']['laravel-generator'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/laravel-generator.git"
    ];
$composer_json['repositories']['adminlte-templates'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/adminlte-templates.git"
    ];
$composer_json['repositories']['datagrid'] = [
        "type" => "vcs",
        "url" => "https://github.com/shemgp/datagrid"
    ];

$composer_json["minimum-stability"] = "dev";

file_put_contents($file, json_encode($composer_json, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
echo "done\n";

echo "Running composer update...\n";
shell_exec("composer update");
echo "done\n";

echo "Running configs...";
shell_exec("php artisan vendor:publish -n");
shell_exec("php artisan admin:install -n");
shell_exec("php artisan infyom:publish -n");
shell_exec("php artisan infyom.publish:layout -n");
echo "done\n";

echo "Changing default layout...";
$config_file = 'config/infyom/laravel_generator.php';
$config = file_get_contents($config_file);
$config = preg_replace('/\'default_layout\'.*=> \$package_view_name.\'[^\']*\',/',
    '\'default_layout\'    => $package_view_name.\'admin::index\',', $config);
file_put_contents($config_file, $config);
echo "done\n";
